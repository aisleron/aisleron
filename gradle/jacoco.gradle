/*
 * Copyright (C) 2026 aisleron.com
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

apply plugin: 'jacoco'

tasks.register('codeCoverage', JacocoReport) {
    // The reports to be generated by this task.
    // Run with ./gradlew codeCoverage
    reports {
        html.required.set(true)
        html.outputLocation = layout.buildDirectory.dir('reports/jacoco/codeCoverage/html')
    }

    group = 'verification'

    // Source sets that coverage should be reported for. Please be aware it's
    // adjusted to our project and set classes which best fits to your needs.
    classDirectories.setFrom(
            fileTree(getLayout().getBuildDirectory()) {
                include("/tmp/kotlin-classes/debug/**")
                exclude(
                        "**/R.class",
                        "**/R\$*.class",
                        "**/BuildConfig.*",
                        "**/Manifest\$*.*",
                        "**/airbnb/**/*.*",
                        "**/*Screen*",
                        "**/Showkase*",
                        "**/theme/Theme*",
                        "**/theme/Type*",
                )
            }
    )

    // Source sets that coverage should be reported for.
    def mainSrc = "$project.projectDir/src/main/kotlin"
    sourceDirectories.from(files([mainSrc]))

    // Collection of execution data files to analyze. Please be aware it's adjusted to our project.
    // In the next step I wll show you how to find these files!
    executionData.setFrom(
            fileTree(dir: getLayout().getBuildDirectory(), includes: ["/outputs/**/*.exec", "/outputs/**/*.ec"])
    )
}

tasks.register('testsWithCodeCoverage', JacocoReport) {
    // The reports to be generated by this task.
    // Run with ./gradlew testsWithCodeCoverage
    reports {
        html.required.set(true)
        html.outputLocation = layout.buildDirectory.dir('reports/jacoco/codeCoverage/html')
    }

    group = 'verification'
    dependsOn(tasks.testDebugUnitTest)
    dependsOn(tasks.connectedDebugAndroidTest)

    // Source sets that coverage should be reported for. Please be aware it's
    // adjusted to our project and set classes which best fits to your needs.
    classDirectories.setFrom(
            fileTree(getLayout().getBuildDirectory()) {
                include("/tmp/kotlin-classes/debug/**")
                exclude(
                        "**/R.class",
                        "**/R\$*.class",
                        "**/BuildConfig.*",
                        "**/Manifest\$*.*",
                        "**/airbnb/**/*.*",
                        "**/*Screen*",
                        "**/Showkase*",
                        "**/theme/Theme*",
                        "**/theme/Type*",
                )
            }
    )

    // Source sets that coverage should be reported for.
    def mainSrc = "$project.projectDir/src/main/kotlin"
    sourceDirectories.from(files([mainSrc]))

    // Collection of execution data files to analyze. Please be aware it's adjusted to our project.
    // In the next step I wll show you how to find these files!
    executionData.setFrom(
            fileTree(dir: getLayout().getBuildDirectory(), includes: ["/outputs/**/*.exec", "/outputs/**/*.ec"])
    )
}